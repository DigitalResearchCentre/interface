<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
  <title>PR Example -- ajax</title>
  


  <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
  <script src="dynatree/jquery/jquery.js" type="text/javascript"></script>
  <script src="dynatree/jquery/jquery-ui.custom.js" type="text/javascript"></script>
   <link href="dynatree/src/skin/ui.dynatree.css" rel="stylesheet" type="text/css" id="skinSheet">
   <script src="dynatree/dist/jquery.dynatree-1.2.4.js" type="text/javascript"></script>
    <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
    <!-- removed jqueryui as this interferes with mergeley -->
	<!-- script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script -->
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
  <!-- script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script-->
  <script src="jquery.corner.js" type="text/javascript"></script>
<script src="codemirror-3.13/lib/codemirror.js"></script>
<link rel="stylesheet" href="codemirror-3.13/lib/codemirror.css">
<script src="codemirror-3.13/mode/xml/xml.js"></script>
<script src="moment.min.js"></script>
<script type="text/javascript"
    src="http://maps.googleapis.com/maps/api/js?key=AIzaSyCOf5NdCQ0GxTBjCX1kVtavpMo-G9u_2BU&sensor=false">
  </script>
  <script type="text/javascript"
    src="map.js">
  </script>
  <script type="text/javascript" src="mergely-3.3.3/lib/mergely.js"></script>
  <link type="text/css" rel="stylesheet" href="mergely-3.3.3/lib/mergely.css" />
   <link href="TCeditor.css" rel="stylesheet" type="text/css">

   
   
<script type="text/javascript">
	var mintocwidth=200;
	var minheight=760;
    var url = "http://textualcommunities.usask.ca/api/"; 
    var community="CT2";   
    var editor=null;	
    var editorstring="";
    var search = location.search.substr(1);
    if (search)  {
      var params = search.split('&');
      for (var i=0; i<params.length; i++) {
        var param = params[i].split('=');
        var key = param[0];
        var value = param[1];
        if (key == 'community') {
          community = value;
        }
      }
    }
    
    function loadTexts (mycommunity) {
		$.getJSON(url+'communities/?page_size=0&format=json',  function (data) { 
			$.each(data, function(h, thiscommunity){ 
				if (thiscommunity.abbr==mycommunity) {
					var rootMenu="[";
					var doccount=0;
					$.getJSON(url+'communities/'+thiscommunity.id+'/docs/?page_size=0&format=json', function (docdata) {
							var numdocs=docdata.length;
							$.each(docdata, function(i, thisdoc) {
							doccount+=1;
							rootMenu+="{title:'"+thisdoc.name+"',isLazy: true, url:'"+thisdoc.id+"'}";
							if (doccount==numdocs) {
								rootMenu+="]";
								makeTextMenu(rootMenu);
								 var setWidth = $("#left").width();
								 var wholeWidth=$('body').width()-6;
								  $('#right').width(wholeWidth-setWidth);
								} else {rootMenu+=",";}
							});
					});
				}
			});
		});
	}
		
	function loadPages (mycommunity) {
		$.getJSON(url+'communities/?page_size=0&format=json',  function (data) { 
			$.each(data, function(h, thiscommunity){ 
				if (thiscommunity.abbr==mycommunity) {
					var rootMenu="[";
					var doccount=0;
					$.getJSON(url+'communities/'+thiscommunity.id+'/docs/?page_size=0&format=json', function (docdata) {
							var numdocs=docdata.length;
							$.each(docdata, function(i, thisdoc) {
							doccount+=1;
							rootMenu+="{title:'"+thisdoc.name+"',isLazy: true, url:'"+thisdoc.id+"'}";
							if (doccount==numdocs) {
								rootMenu+="]";
								makeDMenu(rootMenu);
								 var setWidth = $("#left").width();
								 var wholeWidth=$('body').width()-6;
								  $('#right').width(wholeWidth-setWidth);
								} else {rootMenu+=",";}
							});
					});
				}
			});
		});
	}
	
		function loadEntities (mycommunity) {
		$.getJSON(url+'communities/?page_size=0&format=json',  function (data) { 
			$.each(data, function(h, thiscommunity){ 
				if (thiscommunity.abbr==mycommunity) {
					var rootMenu="[";
					var entcount=0;
					$.getJSON(url+'communities/'+thiscommunity.id+'/entities/?page_size=0&format=json', function (entdata) {
							var numents=entdata.length;
							$.each(entdata, function(i, thisent) {
							entcount+=1;
							rootMenu+="{title:'"+thisent.name+"',isLazy: true, url:'"+thisent.id+"'}";
							if (entcount==numents) {
								rootMenu+="]";
								makeEntMenu(rootMenu);
								 var setWidth = $("#left").width();
								 var wholeWidth=$('body').width()-6;
								  $('#right').width(wholeWidth-setWidth);
								} else {rootMenu+=",";}
							});
					});
				}
			});
		});
	}


//if we have a page -- activate the menu, find and show this page
function doLazyRead (node, editpage) {
			$.getJSON(url+'docs/'+node.data.url+'/has_parts?page_size=0&format=json',function(thisdoc){
			  	node.setLazyNodeStatus(DTNodeStatus_Loading);
			    var children = "[";
				var pagecount=0;
			     $.each(thisdoc, function(i, pageurl) {
					pagecount+=1;
					children+="{title:'"+pageurl.name+"', pageid:'"+pageurl.id+"'}";
					if (pagecount==thisdoc.length) {
						children+="]";
						node.setLazyNodeStatus(DTNodeStatus_Ok);
						node.addChild(eval(children));
						if (editpage) {
							node.expand();
							//now find the node for this page
							$.each(node.getChildren(), function(h, thispage) {
								if (thispage.data.title==editpage) {
									loadTCDocIdText(thispage.data.pageid, thispage.data.key);
								}
							});
						}
					} else {
						children+=","
					}
			  });
	 	});
}
	
function makeDMenu(rootMenu) {
	$("#tree").dynatree({
      children: eval(rootMenu),
      onActivate: function(node) {
			if ( node.data.pageid) {
				loadTCDocIdText(node.data.pageid, node.data.key);
			}
		},
      onLazyRead: function(node){
      		doLazyRead(node, "")
	    }
     });
    var containerheight=$(window).height();
     if (containerheight<minheight) containerheight=minheight;
     $( ".dynatree-container").height(containerheight-34);
     //now
       initTextDtree("Hg", "2r");
}

function makeTextMenu(rootMenu) {
	$("#texttree").dynatree({
		children: eval(rootMenu),
	  	onActivate: function(node) {
	  		if ( node.data.lineid) {
				var entityText="";
				var numdocs=0;
				$.getJSON(url+'entities/'+node.data.lineid+'/has_text_of/'+node.data.parentid+'?format=json',function(thisdoc){
					var mynum=thisdoc.results[0].id;
					$.getJSON(url+'texts/'+mynum+'/is_text_in?format=json',function(thispart){
						if (thispart.depth==2) { alert("fixme")}
						else {
							$.getJSON(url+'docs/'+thispart.id+'/parent?format=json',function(thispart2){
								if (thispart2.depth==2) {
									$.getJSON(url+'docs/'+thispart2.id+'/parent?format=json',function(thispart3){
										initTextDtree(thispart3.name, thispart2.name);
									});
								 }
							});
						}
					});
				});
			}
	  	},
	  	onLazyRead: function(node) {
	  		if (node.data.parentid) {
	  			var thisurl=url+'docs/'+node.data.parentid+'/has_entities/'+node.data.url+'/?page_size=0&format=json';
	  		} else {
	  			var thisurl=url+'docs/'+node.data.url+'/has_entities?page_size=0&format=json';
	  		}
	  			$.getJSON(thisurl,function(thisdoc){
	  			node.setLazyNodeStatus(DTNodeStatus_Loading);
			    var children = "[";
				var pagecount=0;
				if (thisdoc.length!=0) {
					 $.each(thisdoc, function(i, pageurl) {
							pagecount+=1;
							if (pageurl.has_parts) {
								children+="{title:'"+pageurl.name+"', isLazy: true, url:'"+pageurl.id+"', parentid:'"+node.data.url+"'}";
							}  else {
								children+="{title:'"+pageurl.name+"', lineid:'"+pageurl.id+"', parentid:'"+node.data.parentid+"'}";
							}	
							if (pagecount==thisdoc.length) {
								children+="]";
								node.setLazyNodeStatus(DTNodeStatus_Ok);
								node.addChild(eval(children));
							} else {
								children+=",";
							}
					 });
				 } else node.setLazyNodeStatus(DTNodeStatus_Ok);
	  		});
	  	}
     });
     var containerheight=$(window).height();
     if (containerheight<minheight) containerheight=minheight;
     $( ".dynatree-container").height(containerheight-34);
}

function makeEntMenu(rootMenu) {
	$("#entitytree").dynatree({
      children: eval(rootMenu),
      onActivate: function(node) {
			if ( node.data.lineid) {
				var entityText="";
				var numdocs=0;
				$.getJSON(url+'entities/'+node.data.lineid+'/has_text_of?page_size=0&format=json',function(thisdoc){
					 $.each(thisdoc, function(i, pageurl) {
					 	numdocs+=1;
					 	$.getJSON(url+'texts/'+pageurl.id+'/xml',function(thispage){
					 		var newpage=thispage.replace(/</g, "&lt;");
					 		$.getJSON(url+'texts/'+pageurl.id+'/is_text_in?page_size=0&format=json',function(thistext){
					 			var info=""+thistext.label+" "+thistext.name+": "+ newpage + "</p>";
					 				$.getJSON(url+'docs/'+thistext.id+'/parent?page_size=0&format=json',function(thisparent){
					 					info=""+thisparent.label+" "+thisparent.name+"</a>, "+info;
					 					$.getJSON(url+'docs/'+thisparent.id+'/parent?page_size=0&format=json',function(grandparent){
					 						info="<p><a href=\"javascript:initTextDtree('"+grandparent.name+"', '"+thisparent.name+"')\">"+grandparent.label+" "+grandparent.name+", "+info;
					 						entityText+=info;
					 						if (numdocs==thisdoc.length) {
					 							$('#showcollation').html(entityText);
					 						}
					 					});
					 				});
					 		});
					 	});
					 });
				});
			}
		},
      onLazyRead: function(node){
      		$.getJSON(url+'entities/'+node.data.url+'/has_parts?page_size=0&format=json',function(thisdoc){
			  	node.setLazyNodeStatus(DTNodeStatus_Loading);
			    var children = "[";
				var pagecount=0;
			     $.each(thisdoc, function(i, pageurl) {
						pagecount+=1;
						if (pageurl.has_parts) {
							children+="{title:'"+pageurl.name+"', isLazy: true, url:'"+pageurl.id+"'}";
						}  else {
							children+="{title:'"+pageurl.name+"', lineid:'"+pageurl.id+"'}";
						}	
						if (pagecount==thisdoc.length) {
							children+="]";
							node.setLazyNodeStatus(DTNodeStatus_Ok);
							node.addChild(eval(children));
						} else {
							children+=",";
						}
			     });
	 	    });
	    }
     });
    var containerheight=$(window).height();
     if (containerheight<minheight) containerheight=minheight;
     $( ".dynatree-container").height(containerheight-34);
}

function loadTCDocumentText (doctext, pagekey) {
		//set up transcript menus
		
		var tabindex=$("#tabs").tabs('option', 'selected');
		if (tabindex==1) {
			editorstring=doctext;
			$('#tabs').tabs('select', 0);
		} else {
			//could be in mergely...
			if (!editor) {
				if ($('#mergely-resizer').length>0) $('#mergely-resizer').remove();
				$('#transcripttext').html('<textarea id="code"></textarea>');
				editor = CodeMirror.fromTextArea(document.getElementById("code"), {lineWrapping: true, lineNumbers: true});
				editor.setSize($(window).width()-$('#left').width(), $("#transcripttext").parent().parent().height()-49);
			}
			editor.setValue(doctext);
		}
		var tree =$("#tree").dynatree("getTree");
		var pnode=tree.getNodeByKey(pagekey);
		pnode.activate();
		var activeLi = pnode.li;
		 tabindex=$("#tabs").tabs('option', 'selected');
		 if (tabindex==0) {
		 	if ($('#tree').is(':visible')) {
				$('.dynatree-container').animate({ // animate the scrolling to the node
				  scrollTop: $(activeLi).offset().top - $('.dynatree-container').offset().top + $('.dynatree-container').scrollTop()
				}, 'slow');
			}
		}
		$('#docid').html(pnode.getParent().data.title);
		$('#ptitle').html(pnode.data.title);	
		prevnode=pnode.getPrevSibling();
		if 	(prevnode) {
			$('#prevpage').html('<a class="pagelink" title="'+prevnode.data.title+'" href="javascript:loadTCDocIdText(\''+prevnode.data.pageid+'\',\''+prevnode.data.key+'\')">&lt;</a>');
		} else $('#prevpage').html("");
		nextnode=pnode.getNextSibling();
		if 	(nextnode) {
			$('#nextpage').html('<a  class="pagelink" title="'+nextnode.data.title+'" href="javascript:loadTCDocIdText(\''+nextnode.data.pageid+'\',\''+nextnode.data.key+'\')">></a>');
		} else $('#nextpage').html(""); 
}

 $(function() {
    $.ajaxSetup({
        error: function(jqXHR, exception) {
            if (jqXHR.status === 0) {
                alert('Error for '+this.url+': '+'No connection.\n Verify Network.');
            } else if (jqXHR.status == 404) {
                alert('Error for '+this.url+': '+'Requested page not found. [404]');
            } else if (jqXHR.status == 500) {
                alert('Error for '+this.url+': '+'Internal Server Error [500].');
            } else if (exception === 'parsererror') {
                alert('Error for '+this.url+': '+'Requested JSON parse failed.');
            } else if (exception === 'timeout') {
                alert('Error for '+this.url+': '+'Ajax request aborted.');
            } else {
                alert('Error for '+this.url+': '+'Uncaught Error.\n' + jqXHR.responseText);
            }
        }
    });
});


$(function() {
	$( "#tabs" ).tabs({ active: 0 });
	$("#tabs").on("tabsselect", function(e, tab) {
		if (( tab.index==0) && !$('#info').is(':visible')) {
			$("#showcollation").css({'display':'none'});
			$("#info").css({'display':'block'});
			$("#topright").css({'display':'block'});
			$("#lowerright").css({'display':'block'});	
		}
		if (tab.index==1) {
			$("#showcollation").css({'display':'block'});
			$("#info").css({'display':'none'});
			$("#topright").css({'display':'none'});
			$("#lowerright").css({'display':'none'});
		}
    });
});

function initTextDtree(editdoc, editpage) {
	//choose the document, find and initialize the node,then show the text etc for it
	var tree =$("#tree").dynatree("getTree");
	var root=tree.getRoot();
	$.each(root.getChildren(), function(h, thisdoc){ 
		if (thisdoc.data.title==editdoc) {
			doLazyRead (thisdoc, editpage);
		}
	});
}

 $(document).ready(function() {
 	editor = CodeMirror.fromTextArea(document.getElementById("code"),{lineWrapping: true, lineNumbers: true});
 	var setWidth1 = $("#left").width();
 	var infdivheight=$("#info").height()+26;
	var leftwidth=$('#left').width();
  	var containerheight=$(window).height();
 	var containerwidth=$(window).width();
 	if (containerheight<760) containerheight=760;
 	var toprightheight=containerheight*48/100;
 	var lowerrightheight=containerheight*48/100;
 	$( "#closepanel").css("left", (setWidth1 - 18)+'px');
     $( "#left").height(containerheight-18);
     $( "#tree").height(containerheight-18);
     $( ".dynatree-container").height(containerheight-34);
    $( "#left").resizable({ handles: 'e'});
     $( "#topright" ).css("position", 'relative');
	$( "#topright" ).css("top", '-'+infdivheight+'px');
	$( "#docimage").css("top", '-5px');
    $( "#docimage").css("position", 'relative');
 	$( "#topright" ).height(toprightheight+infdivheight/2+12);
 //  	$( "#image").width($('#topright').width()-14);
//    $( "#image").height($('#topright').height());
   $( "#lowerright" ).css("position", 'relative');
	$( "#lowerright" ).css("top", '-'+infdivheight+'px');
	$( "#lowerright" ).height(containerheight-toprightheight+18);
	$( "#right" ).height(containerheight+72);
	$( "#transcripttext").height($("#transcripttext").parent().height()-60);
	var rightsize=$("#right").width();
	editor.setSize(containerwidth-leftwidth, $("#transcripttext").parent().parent().height()-60);


	 $( "#topright").resizable({   
    	handles: 's', 
    	resize: function(event, ui) {
        ui.size.width = ui.originalSize.width;
		}
	 });
    $("#left ").on("resize", function (event, ui) {
            var setWidth = $("#left").width();
            var wholeWidth=$('body').width()-6;
            $('#right').width(wholeWidth-setWidth);
            $('#topright').width(wholeWidth-setWidth-12);
            $( "#right" ).css( "minWidth", (mintocwidth)+'px');
            $( "#left" ).css( "minWidth", (mintocwidth)+'px');
            $( "#closepanel" ).css("left", (setWidth - 18)+'px');
        });
    $("#topright").on("resize", function (event, ui) {
   		if ($('#left').is(':visible'))
        	var setWidth = $("#left").width();
        else var setWidth = 0;
        var wholeWidth=$('body').width()-6;
		var topHeight = $("#topright").height();
		var wholeHeight=$("#right").height()-6;
//		var imageDivHeight=$('#docimage').parent().parent().height();
//		$('#docimage').height(imageDivHeight);
		$('#lowerright').height(wholeHeight-topHeight - 14);
		$('#transcript').height(wholeHeight-topHeight- 16);
		$( "#transcripttext").height($("#transcripttext").parent().parent().height()-62);
		if (editor)
			editor.setSize($("#transcripttext").parent().parent().width(), $("#transcripttext").parent().parent().height()-62);
		else {
			$('#mergely-resizer').height($("#transcripttext").parent().height()-62);
			$('#mergely-resizer').width($("#transcripttext").parent().width());
			$('#compare').mergely('resize');
		}
       $('#topright').width(wholeWidth-setWidth-12);
 		$( "#topright").css( "minHeight", '200px');
 		$( "#topright").css("maxHeight", (wholeHeight-213)+'px');
		$( "#lowerright" ).css( "minHeight",'200px');
	});
  });

    $(window).resize(function (event) {
 //      alert("resizing");
 		var wholeWidth=$('body').width()-6;
 		var whichEl =event.target;
 		var topright=$('#topright')[0];
 		if (whichEl==topright) return;
 		if ($('#splitright').attr('name')=="ishorizontal") {
 	 		if ($('#left').is(':visible'))  {
 			//lots of calculating to do... 
 			var origleft=$("#left").width();
 			var origright=$("#right").width();
 			 $('#right').height(wholeheight-12);
 //				 
 		//	$( "#transcripttext").height($("#transcripttext").parent().parent().height()-49);
 		//	editor.setSize($("#transcripttext").parent().parent().width(), $("#transcripttext").parent().parent().height()-49);
			console.log('left: '+origleft+' right: '+origright+' total '+(origleft+origright)+' body: '+wholeWidth);
 			//window growing!
 			if (wholeWidth>=origleft+origright) {
 				//grow editing panel only
				 $( "#right" ).css( "maxWidth", '');
 				 $('#right').width(wholeWidth-origleft);
 				 $('#topright').width(wholeWidth-origleft-12);
 				 $( "#topright").css( "maxHeight", "");
 				 var wholeheight=$(window).height()-6;
 				 if (wholeheight>minheight) {
 				 	 $('#left').height(wholeheight-12);
  				 	 $( ".dynatree-container").height(wholeheight-26);
	
				 	 //have to test whether windows are vert or horiz
					 var toprightheight= $('#topright').height();
					 var infdivheight=$("#info").height()+12;
					  $('#lowerright').height(wholeheight-toprightheight);
					  //does the lowerright contain the image div?
					  if ($('#docimage').parent().attr('id')=='transcript') {
					  	 $('#docimage').height(wholeheight-toprightheight-infdivheight);
					  }
 				 }
 			} else {
 				console.log("shrinking");
 				//steal size from left panel until it reaches min-width (100 px)
 				var subtract = (origleft+origright)-wholeWidth;
 				console.log("remove this "+subtract);
 				if ( (origleft-subtract)< mintocwidth) {
 					if (origleft>mintocwidth) {
 						console.log("here");
						subtract=mintocwidth+subtract-origleft;
						 $('#left').width(mintocwidth);
						 $( "#closepanel" ).css("left", 82+'px');
						 $('#right').width(origright+subtract);
					} else {
						$('#right').width(origright-subtract);
					}
 				} else {
 					//make left panel smaller
 					$('#left').width(origleft-subtract);
 					$( "#closepanel" ).css("left", (origleft-subtract-18)+'px');
 					$('#right').width(origright+subtract);
 				}
 			}
 		} else {
 			$( "#right" ).css( "maxWidth", '');
 			$('#right').width($('body').width()-6);
 		}
	}
 });

function hideTOC(){
	var leftWidth=$('#left').width();
	$('#left').hide();
	var wholeWidth=$('body').width()-6;
	$('#right').width(wholeWidth);
	$('#openpanel').show();
	$( "#right" ).css("left", '0px');
	$( "#right" ).css("position", 'relative');
	$( "#right" ).css("top", '-19px');
	$( "#right" ).css( "maxWidth",wholeWidth);
	$( "#right" ).css( "float", "left");
	if ($('#splitright').attr('name')=="ishorizontal") {
		$( "#topright" ).width(wholeWidth-12);
	} else {
		$( "#topright" ).width($( "#topright" ).width()+leftWidth/2);
		$( "#lowerright" ).width($( "#lowerright" ).width()+leftWidth/2);
//		$('#image').width($("#image").parent().width()-8);
	}
	$("#transcripttext").width($("#transcripttext").parent().parent().width());
	if (editor) editor.setSize($("#transcripttext").parent().parent().width(), $("#transcripttext").parent().parent().height()-62);
	else {
			$('#mergely-resizer').height($("#transcripttext").parent().height()-62);
			$('#mergely-resizer').width($("#transcripttext").parent().width());
			$('#compare').mergely('resize');
		}
}

var imageLoaded=0;
function loadTCDocIdText(pageid, pagekey) {
	if (!imageLoaded) {
		var imagecall='<script type="text/javascript"> \
							var $imageMap = $(".image_map");\
							var options = {\
									zoom: 2 ,\
									minZoom: 1,\
									maxZoom: 5 \
							};\
							var imageMap = new ImageMap($imageMap[0], "http://textualcommunities.usask.ca/api/docs/'+pageid+'/has_image/", options);';
		$('#docimage').html(imagecall);
		imageLoaded=1;
	}
	//this version for getting the current revision:
	//test: is there a revision? if so... show it
	//set up menus for showing revisions, etc
		$.getJSON(url+'docs/'+pageid+'/?format=json',function(thetext) {
			if (thetext.cur_rev) {
				//if we have several versions -- call up the revision system
				//first, test how many revisions we have
				$.getJSON(url+'docs/'+pageid+'/has_revisions/?page_size=0&format=json', function(versions) {
					if (versions.length==1) {
						$.getJSON(url+'docs/'+pageid+'/cur_revision/?page_size=0&format=json',function(thetext){
							$.getJSON(url+'users/'+thetext.user+'/?page_size=0&format=json',function(user) {
								$('#transcriptinf').html('Only one edited version ('+thetext.edit_date+', '+user.first_name+' '+user.last_name+').  <a href="javascript:compareToDb('+pageid+', '+thetext.id+')">Compare to database.</a>');
								loadTCDocumentText(thetext.text, pagekey);
								createTranscriptMenus(pageid, thetext.id, -1).done(function (menus) {
									$('#revinf1').html(menus.left);
									$('#revinf2').html(menus.right);
								});
								imageLoaded=0;
							});
						});
					} else {
						//we have more than one revision -- prepare compare view
						$.getJSON(url+'docs/'+pageid+'/cur_revision/?format=json',function(thetext){
							$('#transcriptinf').html('Several versions.  Compare with each other, and the database.');
							loadTCDocumentText(thetext.text, pagekey);
							createTranscriptMenus(pageid, thetext.id, -1).done(function (menus) {
									$('#revinf1').html(menus.left);
									$('#revinf2').html(menus.right);
								});
							imageLoaded=0;
						});
					}
				});
			}  else {
				$.getJSON(url+'docs/'+pageid+'/has_text_in?format=json',function(hastextin){
					$.getJSON(url+'texts/'+hastextin.id+'/xml',function(thetext){
						$('#transcriptinf').html('No edited versions: as loaded in database');
						loadTCDocumentText(thetext, pagekey);
						createTranscriptMenus(pageid, 0, -1).done(function (menus) {
								$('#revinf1').html(menus.left);
								$('#revinf2').html(menus.right);
						});
						imageLoaded=0;		
					});
				});
			}
		});
}

function setupMergely(text1, text2) {
//get rid of codemirror instance, if there is one...
	if (editor) {
		var oldeditor=editor.getWrapperElement();
		if (oldeditor.parentNode) {
			oldeditor.parentNode.removeChild(oldeditor);
			editor=null;
		}
	}
//if there is a mergely, just write in new text
	if ($('#mergely-resizer').length>0) {
		$('#compare').mergely('lhs', text1);
		$('#compare').mergely('rhs', text2);
	}
//alter html
	$('#transcripttext').height($('#transcripttext').parent().height()-70)
  	newtext1=text1.replace(/\t/g, "");
	newtext2=text2.replace(/\t/g, "");
	newtext3=newtext1.replace(/  /g, "");
	newtext4=newtext2.replace(/  /g, "");
	$('#transcripttext').html("<div id=\"mergely-resizer\"><div id=\"compare\"></div></div>");
	$('#mergely-resizer').height($('#transcripttext').height());
		 $('#compare').mergely({
			height: "auto",
			width: "auto",
			cmsettings: { readOnly: false },
			lhs: function(setValue) {
				setValue(newtext3);
			},
			rhs: function(setValue) {
				setValue(newtext4);
			}
		});
}

function getUserInf(user) {
	var userinf={}
	for (var i in users) {
		if (users[i].id==user) {
			userinf.first_name=users[i].first_name;
			userinf.last_name=users[i].last_name;
			return userinf;
		}
	}
	userinf.first_name="Unknown";
	userinf.last_name="Unknown";
	return userinf;
}

var users;
function getUsers() {
	 return $.getJSON(url+'users/?page_size=0&format=json', function(allusers) {
	 	users=allusers;
	 });
}
//left and right will be revision ids for comparison; if 0 then compare to database; if -1 set to none
function createTranscriptMenus (pageid, left, right) {
		return $.getJSON(url+'docs/'+pageid+'/has_revisions/?page_size=0&format=json', function(versions) {
			 	//do the left first
			var leftMenu='<select id="leftSelTranscript" onchange="javascript:doTranscriptVersions('+pageid+')">';
			for (var i=0; i < versions.length; i++) {
				var userInf=getUserInf(versions[i].user);
				if (versions[i].id!=right) {
					if (versions[i].id==left) {
						var d = Date.parse(versions[i].edit_date);
						var x= moment(versions[i].edit_date).format('LLL');
						leftMenu+='<option value="'+versions[i].id+'" selected="selected">'+moment(versions[i].edit_date).format('MMMM Do YYYY, h:mm:ss a')+': '+userInf.first_name+' '+userInf.last_name+'</option>';
					}
					else leftMenu+='<option value="'+versions[i].id+'">'+moment(versions[i].edit_date).format('MMMM Do YYYY, h:mm:ss a')+': '+userInf.first_name+' '+userInf.last_name+'</option>';
				}
			}
			//append database version
			if (right!=0) {
				if (left==0) leftMenu+='<option value="0" selected="selected">Version in database</option>' 
				else  leftMenu+='<option value="0">Version in database</option>';
			}
			leftMenu+="</select>";
			versions.left=leftMenu;
			//now, let's build the right-hand menu
			var rightMenu='<select  id="rightSelTranscript" onchange="javascript:doTranscriptVersions('+pageid+')">';
			if (right==-1) rightMenu+='<option value="-1"  selected="selected">[Show this version only]</option>';
			else  rightMenu+='<option value="-1">[Nothing]</option>';
			for (var i=0; i < versions.length; i++) {
				var userInf=getUserInf(versions[i].user);
				if (versions[i].id!=left) {
					if (versions[i].id==right) 
						rightMenu+='<option value="'+versions[i].id+'" selected="selected">'+moment(versions[i].edit_date).format('MMMM Do YYYY, h:mm:ss a')+': '+userInf.first_name+' '+userInf.last_name+'</option>';
					else rightMenu+='<option value="'+versions[i].id+'">'+moment(versions[i].edit_date).format('MMMM Do YYYY, h:mm:ss a')+': '+userInf.first_name+' '+userInf.last_name+'</option>';
				}
			}
			if (left!=0) {
				if (right==0) rightMenu+='<option value="0" selected="selected">Version in database</option>' 
				else  rightMenu+='<option value="0">Version in database</option>';
			}
			rightMenu+="</select>";
			versions.right=rightMenu;
			//set values on various save buttons
			if (right==-1) {
				//just one to deal with...
				$('#tcnt1').hide();
				$('#tcnt3').hide();
				$('#tcnt2').show();
				$('#tcnt2').css('width', '100%');
				$('#tcntSave').attr('value', pageid);
			} else {
				//got to set for both left and right
				$('#tcnt1').show();
				$('#tcnt2').width(0);
				$('#tcnt1').css('width', '50%');
				$('#tcnt3').show();
				$('#tcnt1').css('width', '50%');
				$('#tcnt2').hide();		
				$('#tcntSaveLeft').attr('value', pageid);
				$('#tcntSaveRight').attr('value', pageid);
			}
		});
}

function SaveTranscript() {
	if (editor) {
		var pageid=$('#tcntSave').attr('value');
		$.post('http://textualcommunities.usask.ca/api/transcribe/', {
				text: editor.getValue(),
				doc: pageid
			}).success(function(){
				//redo the transcript menus here
				alert('success');
			}).fail(function(xhr){
					alert(xhr.responseText);
			});
	}
}
//compare a transcript to the database version
function compareToDb(pageid, versionid) {
	//get the database version
		$.getJSON(url+'docs/'+pageid+'/has_text_in?format=json',function(hastextin){
				$.getJSON(url+'texts/'+hastextin.id+'/xml',function(dbtext){
					//got db text.  Get the transcript...
					$.getJSON(url+'docs/'+pageid+'/has_revisions/?page_size=0&format=json', function(versions) {
						$.each(versions, function(i, thisrevision) {
							if (thisrevision.id==versionid) {
								var mytext=thisrevision.text;
								createTranscriptMenus(pageid, 0, versionid).done(function (menus) {
									$('#revinf1').html(menus.left);
									$('#revinf2').html(menus.right);
									setupMergely(dbtext, mytext);
								});
							}
						});
					});
				});
		});
}

//we don't use it now -- leave it as one day it might help!
function loadTCDocPartText(thisurl, mycommunity, document, documentpath) {
	//get the community first
	$.getJSON(thisurl+'communities/?format=json',  function (data) { 
			$.each(data.results, function(h, thiscommunity){ 
				if (thiscommunity.name==mycommunity) {
					//get the doc we want
					$.getJSON(url+'communities/'+thiscommunity.id+'/docs/?format=json', function (docdata) {
						$.each(docdata.results, function(i, thisdoc) {
							if (thisdoc.name==document)  {
							//now start looking for the document path
								$.getJSON(url+'docs/'+thisdoc.id+'/has_parts?page_size=0&format=json',function(docpages){
									
									 $.each(docpages, function(i, thispage) {
									 	var this_path=thispage.label+"="+thispage.name;
									 	if (this_path==documentpath) {
									 		//got the page -- now chase the trail to get its text...
									 		$.getJSON(url+'docs/'+thispage.id+'/has_text_in?format=json',function(hastextin){
									 			$.getJSON(url+'texts/'+hastextin.id+'/xml',function(thetext){
									 				loadTCDocumentText(thetext, "");
									 			});
											});
										}
									});
								});
							}
						});
					});
				}
			});
	});
}

function doTranscriptVersions(pageid) {
	var leftPage=$("#leftSelTranscript :selected").val();
	var rightPage=$("#rightSelTranscript :selected").val();
	loadTranscripts(pageid, leftPage, rightPage);
}

function loadTranscripts(pageid, leftPage, rightPage) {
	//if rightPage is -1: just load the left 
	if (rightPage==-1) {
		if ($('#mergely-resizer').length>0) {
			$('#mergely-resizer').remove();
			$('#transcripttext').html('<textarea id="code"></textarea>');
			editor = CodeMirror.fromTextArea(document.getElementById("code"), {lineWrapping: true, lineNumbers: true});
			editor.setSize($(window).width()-$('#left').width(), $("#transcripttext").parent().parent().height()-49);
		}
		if (leftPage==0) {
			//get db
			$.getJSON(url+'docs/'+pageid+'/has_text_in?format=json',function(hastextin){
				$.getJSON(url+'texts/'+hastextin.id+'/xml',function(dbtext) {editor.setValue(dbtext)});
			});
		} else {
			$.getJSON(url+'docs/'+pageid+'/has_revisions/?page_size=0&format=json', function(versions) {
				$.each(versions, function(i, thisrevision) {
					if (thisrevision.id==leftPage) {editor.setValue(thisrevision.text)}
				});
			});
		}
	} else {
		if (leftPage==0) {
			$.getJSON(url+'docs/'+pageid+'/has_text_in?format=json',function(hastextin){
				$.getJSON(url+'texts/'+hastextin.id+'/xml',function(dbtext) {
					//rightpage MUST be a version..
					$.getJSON(url+'docs/'+pageid+'/has_revisions/?page_size=0&format=json', function(versions) {
						$.each(versions, function(i, thisrevision) {
							if (thisrevision.id==rightPage) {
								setupMergely(dbtext, thisrevision.text);
							}
						});
					});
				});
			});
		} else {
			//left page: a revision
			$.getJSON(url+'docs/'+pageid+'/has_revisions/?page_size=0&format=json', function(versions) {
				$.each(versions, function(i, thisrevision) {
					if (thisrevision.id==leftPage) {
						//now get the rightpage -- can't be -1
						if (rightPage==0) {
							$.getJSON(url+'docs/'+pageid+'/has_text_in?format=json',function(hastextin){
								$.getJSON(url+'texts/'+hastextin.id+'/xml',function(dbtext) {
									setupMergely(thisrevision.text, dbtext);
								});
							});
						} else {
							$.getJSON(url+'docs/'+pageid+'/has_revisions/?page_size=0&format=json', function(versions2) {
								$.each(versions2, function(i, thisrevision2) {
									if (thisrevision2.id==rightPage) {
										setupMergely(thisrevision.text, thisrevision2.text);
									}	
								});
							});
						}
					}
				});
			});
		}
	}
	createTranscriptMenus(pageid, leftPage, rightPage).done(function (menus) {
			$('#revinf1').html(menus.left);
			$('#revinf2').html(menus.right);
	});
}


//topright: becomes left, lowerright goes to the right

var saveWinSpecs = {};
function splitvertical () {
 	if ($('#splitright').attr('name')=="ishorizontal") {
 		$("#splitright").attr("name", "isvertical" );
		$('#split').attr('src', 'splithoriz.png');
 		$('#split').attr('title', 'Image and text above and below');
 		saveWinSpecs.toprightheight=$("#topright").height();
 		saveWinSpecs.lowerrightheight=$("#lowerright").height();		
		var wholeWidth=$("#right").width();
		$("#topright").width(wholeWidth/2 -8);
		$("#lowerright").width(wholeWidth/2 - 10);
		var rightheight=$('#right').height();
		$("#right").css({'height': rightheight});
		$("#topright").css({'height': rightheight-10});
		$("#topright").css({'float':'left'});
		$("#topright").css({'margin-right':'0px'});
//		$('#image').height(rightheight-20);
		$("#lowerright").css({'margin-right':'0px'});
		$("#lowerright").css({'float':'left'});
		$("#lowerright").css({'height': rightheight-10});
		$( "#transcripttext").width($("#transcripttext").parent().width());
		$( "#transcript").height($("#transcript").parent().height());
		$( "#transcripttext").height($("#transcripttext").parent().height()-84);
		$( "#topright" ).css("top", '-54px');
		$( "#topright" ).css("maxHeight", '');
		$( "#lowerright" ).css("top", '-54px');
		$( "#transcript").css("position", "relative");
		$( "#transcript").css("top", "12px");
		google.maps.event.trigger(imageMap, 'resize');
//		imageMap.setZoom(imageMap.getZoom());
	//		$('#image').width($("#topright").width()-8);
		if (editor) editor.setSize($("#transcripttext").parent().parent().width(), $("#transcripttext").parent().parent().height()-49);
		else {
			$('#mergely-resizer').height($("#transcripttext").parent().height()-49);
			$('#mergely-resizer').width($("#transcripttext").parent().width());
			$('#compare').mergely('resize');
		}
		$( "#topright" ).resizable( "destroy" );
		$( "#topright").resizable({   
			handles: 'e', 
			resize: function(event, ui) {
			ui.size.height = ui.originalSize.height;
			}
		 });
		 $("#topright").off("resize", "");
		 $("#topright").on("resize", function (event, ui) {
			if ($('#left').is(':visible'))
				var setWidth = $("#left").width();
			else var setWidth = 0;
			var wholeWidth=$('body').width()-6;
			var leftWidth = $("#topright").width();
			$('#lowerright').width(wholeWidth-setWidth - leftWidth -20);
			$( "#transcripttext").width($("#transcripttext").parent().width()-5);
			$( "#transcripttext").height($("#transcripttext").parent().height()-67);
			$('#docimage').css( "minWidth", '200px');
			$( "#topright").css( "minWidth", '200px');
	//		$( "#topright").css("maxWidth", (wholeWidth-setWidth-230)+'px');
			$( "#lowerright" ).css( "minWidth",'200px');
	//		$( "#lowerright" ).css( "maxWidth", (wholeWidth-setWidth-220)+'px');
	//		$('#image').width($('#image').parent().width());
	//		$('#docimage').width($('#docimage').parent().parent().width());
	});
	} else {
		$("#splitright").attr("name", "ishorizontal" );
		$('#split').attr('src', 'splitvert.png');
 		$('#split').attr('title', 'Image and text side by side');
 		var proportion=(saveWinSpecs.toprightheight+saveWinSpecs.lowerrightheight)/$('#right').height();
		var infdivheight=$("#info").height()+26;
		saveWinSpecs.toprightwidth=$("#topright").width();
 		saveWinSpecs.lowerrightwidth=$("#lowerright").width();		
 		$("#topright").height(proportion*saveWinSpecs.toprightheight);
 		$( "#topright" ).css("top", '-'+infdivheight+'px');
 		$("#topright").width($("#right").width()-12);
 		$("#lowerright").width($("#right").width()-12);
		$("#lowerright").height(proportion*saveWinSpecs.lowerrightheight+20);
		$( "#transcripttext").width($("#transcripttext").parent().width());
 //		$('#image').height($('#image').parent().height());
 //		$('#image').width($('#image').parent().width());
 //		$('#docimage').height($('#docimage').parent().parent().height());
//		$('#docimage').width($('#docimage').parent().parent().width());
		$("#topright").css({'float':''});
 		$("#lowerright").css({'float':''});
 		$( "#lowerright" ).css("top", '-'+infdivheight+'px');
 		$( "#transcript").css("top", "");
 		$( "#transcripttext").height($("#transcripttext").parent().height()-62);
 		if (editor)
			editor.setSize($("#transcripttext").parent().parent().width(), $("#transcripttext").parent().parent().height()-44);
		else {
			$('#mergely-resizer').height($("#transcripttext").parent().height()-44);
			$('#mergely-resizer').width($("#transcripttext").parent().width());
			$('#compare').mergely('resize');
		}
		$("#topright").resizable( "destroy");
		$("#topright").resizable({   
			handles: 's', 
			resize: function(event, ui) {
			ui.size.height = ui.originalSize.height;
			}
		 });
		 $("#topright").off("resize", "");
		 $("#topright").on("resize", function (event, ui) {
			if ($('#left').is(':visible'))
				var setWidth = $("#left").width();
			else var setWidth = 0;
			var wholeWidth=$('body').width()-6;
			var topHeight = ui.size.height;
			var wholeHeight=$("#right").height()-6;
	//		var imageDivHeight=$('#docimage').parent().parent().height();
	//		$('#docimage').height(imageDivHeight);
			$('#topright').height(topHeight);
			$('#lowerright').height(wholeHeight-topHeight - 14);
			$('#transcript').height(wholeHeight-topHeight- 16);
			$( "#transcripttext").height($("#transcripttext").parent().parent().height()-62);
			if (editor)
				editor.setSize($("#transcripttext").parent().parent().width(), $("#transcripttext").parent().parent().height()-62);
			else {
				$('#mergely-resizer').height($("#transcripttext").parent().height()-62);
				$('#mergely-resizer').width($("#transcripttext").parent().width());
				$('#compare').mergely('resize');
			}
		   	$('#topright').width(wholeWidth-setWidth-12);
			$( "#topright").css( "minHeight", '200px');
			$( "#topright").css("maxHeight", (wholeHeight-213)+'px');
			$( "#lowerright" ).css( "minHeight",'200px');
		});
	}
}

function showTOC(){
	var wholeWidth=$('body').width()-6;
	$('#left').show();
	var leftwidth=$('#left').width();
	$('#openpanel').hide();
	$('#right').width(wholeWidth-leftwidth - 6);
	$( "#right" ).css("left", '0px');
	$( "#right" ).css("top", '0px');
	$( "#closepanel" ).css("left", (leftwidth - 18)+'px');
	if ($('#splitright').attr('name')=="ishorizontal") {
		$( "#topright" ).width(wholeWidth-leftwidth - 18);
	} else {
		$( "#topright" ).width($( "#topright" ).width()-leftwidth/2 - 3);
		$( "#lowerright" ).width($( "#lowerright" ).width()-leftwidth/2 - 3);
//		$('#image').width($("#image").parent().width()-8);
	}
	$( "#transcripttext").width($("#transcripttext").parent().width()-5);
	if (editor) editor.setSize($("#transcripttext").parent().parent().width(), $("#transcripttext").parent().parent().height()-62);
	else {
			$('#mergely-resizer').height($("#transcripttext").parent().height()-62);
			$('#mergely-resizer').width($("#transcripttext").parent().width());
			$('#compare').mergely('resize');
		}
}

function togglepageitem() {
	if ($('#tree').is(':visible')) {
		$("#tree").css({'display':'none'});
		$("#texttree").css({'display':'block'});
		$('#byitemb').removeAttr('href');
		$('#bypageb').attr('href','javascript:togglepageitem()');
		$('#bypageb').css({'cursor':'pointer', 'background-color':'#D2D2D2', 'color':'#999'});
		$('#byitemb').css({'cursor':'default', 'background-color':'#999', 'color':'#fff'});
		$('#bypageb').hover(function() {
			  $('#bypageb').css({'background-color':'#BDBDBD', 'color':'#fff'}); 
		   }, 
		   function() {
			   $('#bypageb').css({'background-color':'#D2D2D2', 'color':'#999'})
		   })
		$("#byitemb").off('mouseenter mouseleave');
	} else {
		$("#tree").css({'display':'block'});
		$("#texttree").css({'display':'none'});
		$('#bypageb').removeAttr('href');
		$('#byitemb').attr('href','javascript:togglepageitem()');
		$('#byitemb').css({'cursor':'pointer', 'background-color':'#D2D2D2', 'color':'#999'});
		$('#bypageb').css({'cursor':'default', 'background-color':'#999', 'color':'#fff'});
		$('#byitemb').hover(function() {
			  $('#byitemb').css({'background-color':'#BDBDBD', 'color':'#fff'}); 
		   }, 
		   function() {
			   $('#byitemb').css({'background-color':'#D2D2D2', 'color':'#999'})
		   })
		$('#bypageb').off('mouseenter mouseleave');
	}
}

function toggleWordWrap() {
	if ($('#wwonb').is('[href]')) {
		editor.setOption("lineWrapping", true);
		$('#wwonb').removeAttr('href');
		$('#wwoffb').attr('href','javascript:toggleWordWrap()');
		$('#wwoffb').css({'cursor':'pointer', 'background-color':'#D2D2D2', 'color':'#999'});
		$('#wwonb').css({'cursor':'default', 'background-color':'#999', 'color':'#fff'});
		$('#wwoffb').hover(function() {
			  $('#wwoffb').css({'background-color':'#BDBDBD', 'color':'#fff'}); 
		   }, 
		   function() {
			   $('#wwoffb').css({'background-color':'#D2D2D2', 'color':'#999'})
		   })
		$("#wwonb").off('mouseenter mouseleave');
	} else {
		editor.setOption("lineWrapping", false);
		$('#wwoffb').removeAttr('href');
		$('#wwonb').attr('href','javascript:toggleWordWrap()');
		$('#wwonb').css({'cursor':'pointer', 'background-color':'#D2D2D2', 'color':'#999'});
		$('#wwoffb').css({'cursor':'default', 'background-color':'#999', 'color':'#fff'});
		$('#wwonb').hover(function() {
			  $('#wwonb').css({'background-color':'#BDBDBD', 'color':'#fff'}); 
		   }, 
		   function() {
			   $('#wwonb').css({'background-color':'#D2D2D2', 'color':'#999'})
		   })
		$('#wwoffb').off('mouseenter mouseleave');
	}
}

function fliptextimage() {
	editorstring = editor.getValue();
	var oldeditor=editor.getWrapperElement();
	oldeditor.parentNode.removeChild(oldeditor);
	editor=null;
	var infdivheight=$("#info").height()+26;
	var origtop=$('#image').html();
	var origbelow=$('#transcript').html();
	var origtopheight=$('#topright').height();
	var origbelowheight=$('#lowerright').height();
	$('#image').html(origbelow);
	$('#transcript').html(origtop);
	$('#image').height(origbelowheight);
	$('#transcript').height(origtopheight);
	$('#topright').height(origbelowheight);
	$('#lowerright').height(origtopheight);
	$( "#transcripttext").width($("#transcripttext").parent().width()-5);
	//have to refresh the editor each time...
	editor = CodeMirror.fromTextArea(document.getElementById("code"), {lineWrapping: true,  lineNumbers: true});
	editor.setValue(editorstring);
	editor.setSize($("#transcripttext").parent().parent().width(), $("#transcripttext").parent().parent().height()-44);
}

</script>

</head>
<body>
<div id="container">
	<a href="javascript:showTOC()"  id="openpanel" title="Open toc panel" style="display:none; position: relative; left:5px; top: 2px; z-index:2;"><img src="openpanel.png" height="16px" id="openpanelimg"></img></a>
	<div id="left">
		<a href="javascript:hideTOC()"  id="closepanel" title="Close toc panel"><img src="closepanel.png" height="16px" id="openpanelimg"></img></a>
			<div id="tabs">
				  <ul>
					<li><a href="#bypage"><span>Documents</span></a></li>
					<li><a href="#byentity"><span>Collations</span></a></li>
				  </ul>
				   <div id="bypage">
				   		<p id="pbypage"><span id="pagebutton"><a id="bypageb">By Page</a></span><span id="itembutton"><a href="javascript:togglepageitem()" id="byitemb">By Item</a></span></a></p>
						 <div id="tree"></div>
						 <div id="texttree"></div>
				   </div>
				   <div id="byentity">
						 <div id="entitytree"></div>
				   </div>
			</div>
	</div>
	<div id="right" style="position:relative; z-index:1;">
		<div id="info"><p><span  id="pageinf"> <span id="prevpage"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span id="docid"></span>; Folio <span id="ptitle"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span id="nextpage"></span></span><a id="splitright" name="ishorizontal" style="float: right; margin-right:10px" href="javascript:splitvertical()" title="Image and text side by side"><img id="split" src="splitvert.png"></a><!--a style="float: right; margin-right:10px" href="javascript:fliptextimage()" title="Transpose image and transcript"><img id="spin" src="spin.png"></a--></p></div>
		<div id="topright">
			 <div id="image">
				 <div id="docimage" class="image_map">
				</div>
			</div>
		</div>
		<div id="lowerright">
			 <div id="transcript">
			 	 <div id="transcriptHeader"><table width="100%"><tr><td class="revinf" id="revinf1"></td><td class="revinf2">Compare with:</td><td  class="revinf" id="revinf2"></td></tr></table></div>
				 <div id="transcripttext">
					<textarea id="code"></textarea>
				 </div>
				 <div id="transcriptcontrols">
					<table width="100%"><tr><td class="tcnt" id="tcnt1"><button id="tcntSaveLeft" value="0" title="Save left transcript page (not to database)" onclick="javascript:SaveLeftTranscript()">Save</button></td><td class="tcnt2" id="tcnt2"><button id="tcntSave" value="0" title="Save transcript page (not to database)" onclick="javascript:SaveTranscript()">Save</button><button>Preview</button><button title="Parse and save to database">Commit</button><button>Publish</button><span id="pww">&nbsp;&nbsp;&nbsp;<span id="wwoffbutton"><a id="wwoffb">Word Wrap Off</a></span><span id="wwonbutton"><a href="javascript:toggleWordWrap()" id="wwonb">Word Wrap On</a></span></span></td><td  class="tcnt" id="tcnt3"><button id="tcntSaveRight" value="0" title="Save right transcript page (not to database)" onclick="javascript:SaveRightTranscript()">Save</button> </td></tr></table>
				 </div>
			</div>
		</div>
		<div id="showcollation">
			<h4>Click on an entity to see all texts of that entity</h4>
		</div>
	</div>
</div>
  <script type="text/javascript">
  	loadPages(community);
  	loadTexts(community);
  	loadEntities(community);
  	getUsers();
 </script>
</body>
</html> 
